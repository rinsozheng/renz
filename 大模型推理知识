##模型参数NZ/ND格式

在讨论大模型推理（尤其是基于 **华为昇腾 Ascend/CANN 架构** 也就是 NPU）时，经常会遇到 **ND** 和 **NZ** 这两种数据格式。

这两个术语并不是通用的深度学习术语（如 PyTorch 中的 NCHW），而是华为昇腾 AI 处理器为了优化矩阵计算而定义的**底层内存排布格式**。

简单来说，**ND 是“人类和框架看懂的格式”，NZ 是“NPU 硬件计算最快的格式”。**

以下是它们的核心区别、原理以及在量化/非量化模型中的作用：

---

### 1. 核心定义区别

| 特性 | ND 格式 (N-Dimension) | NZ 格式 (Fractal Z / Internal Format) |
| :--- | :--- | :--- |
| **别名** | 通用格式 / 线性格式 | 私有格式 / 分形格式 / 块状格式 |
| **内存排布** | 连续的线性排布（Row-major 或 Col-major） | **分块排布**（Block-major），类似“Z”字形 |
| **谁在用** | 上层框架（PyTorch, TensorFlow, MindSpore 源码） | 底层硬件（Ascend NPU 的 Cube 计算单元） |
| **可读性** | 高（可以直接打印查看数值） | 低（数据在内存里被打散重排了） |
| **主要场景** | 数据输入/输出接口、CPU 处理阶段 | **矩阵乘法计算 (MatMul)**、高性能推理阶段 |

---

### 2. 深入解析：为什么要搞一个 NZ 格式？

要理解 ND 和 NZ 的区别，必须了解 AI 芯片（NPU）是如何做矩阵乘法的。

#### ND 格式 (逻辑视图)
在 ND 格式下，一个矩阵在内存中是按行或按列连续存储的。
* **例子：** 一个 $4 \times 4$ 的矩阵，内存里存的是 `[1, 2, 3, 4, 5, 6...]`。
* **缺点：** 昇腾 NPU 的核心计算单元叫 **Cube Unit**，它一次性处理的是 **$16 \times 16$** 的小方块（Fractal）。如果数据是 ND 格式，Cube Unit 每次读取数据时，需要跨很多行去“凑”齐这 $16 \times 16$ 的数据，这会导致严重的缓存未命中（Cache Miss），极大降低计算效率。

#### NZ 格式 (物理视图)
为了喂饱 Cube Unit，昇腾设计了 NZ 格式。它将大矩阵切分成无数个小块（通常是 $16 \times 16$ 或其倍数），在内存中先把第一个 $16 \times 16$ 的块存完，再存下一个块。
* **原理：** 数据在内存中呈现“分形”或“Z字形”排列。
* **优点：** Cube Unit 读取数据时，内存是连续的，直接加载进寄存器计算，不需要在线转置（Transposition），**推理速度最快**。

---

### 3. 量化与非量化模型中的 ND/NZ

在推理部署（Inference）阶段，权重的格式转换是关键步骤。

#### 非量化模型 (FP16 / BF16)
* **存储时：** 原始模型权重通常是 ND 格式。
* **加载时：** 在模型转换（使用 ATC 工具）或加载到 NPU 显存时，驱动层通常会自动将权重矩阵（Weight）从 **ND 重排为 NZ**。
* **计算时：** MatMul 算子要求输入必须是 NZ 格式（或者 NPU 内部在线转换，但会损耗性能）。

#### 量化模型 (INT8 / W8A16 / W8A8)
量化模型对 NZ 格式的依赖更强，且更加复杂。

1.  **数据压缩与对齐：**
    * 量化会将参数压缩（例如 4 个 FP16 压成 1 个 INT64，或者使用特殊的打包方式）。
    * 在量化算子中，为了配合硬件指令（Ascend 里的 `matmul` 指令），量化后的权重往往**必须**直接以 NZ 格式存储在文件中（om 模型），或者在预处理阶段强制转为 NZ。
2.  **K 轴对齐要求：**
    * 由于 NZ 格式通常基于 $16 \times 16$ 的块，这就要求模型的隐藏层维度（Hidden Size）最好能被 16 整除。如果量化导致维度变化，需要通过 Padding（补零）来凑齐 NZ 格式的要求。

### 4. 形象比喻

想象你要搬运一个图书馆的书（数据）：

* **ND 格式（线性）：** 书按照索书号一本接一本排在架子上。
    * *优点：* 人好找。
    * *缺点：* 如果搬家公司（NPU）的箱子一次只能装“特定类别的 16 本书”，那工人就得在书架间跑来跑去凑满一箱，效率极低。

* **NZ 格式（分块）：** 书已经被预先打包进了标准的 $16 \times 16$ 规格的箱子里。
    * *优点：* 搬家公司（NPU）来了直接搬箱子，速度极快。
    * *缺点：* 你想找某一本书看时，得先拆箱子（转回 ND），很麻烦。

### 5. 总结与建议

* **ND** 是逻辑格式，通用性强，用于输入输出。
* **NZ** 是物理格式，性能最强，用于 NPU 内部计算。

**对于开发者/算法工程师的建议：**
1.  **模型转换：** 在使用华为 `atc` 工具转模型时，通常不需要你手动处理，工具会自动将权重转为 NZ 格式以加速推理。
2.  **自定义算子：** 如果你在编写 TBE/CANN 自定义算子，你必须明确你的输入是 ND 还是 NZ。如果算子内部涉及矩阵乘法，务必确保数据已转换为 NZ 格式。
3.  **性能排查：** 如果发现 NPU 推理速度不如预期，检查一下是否在该用 NZ 的地方用了 ND，导致 NPU 在计算过程中不得不花费算力去进行格式转换（TransData 操作）。
